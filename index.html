<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إمبراطورية المخدرات - النسخة المظلمة</title>
<style>
  body {
    background: linear-gradient(135deg, #0a0014 0%, #220033 100%);
    color: #e0caff;
    font-family: 'Courier New', monospace;
    margin: 0; padding: 0; 
  }
  #game-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: #1a0033;
    border-radius: 12px;
    box-shadow: 0 0 30px #7a0eff88;
  }
  h1, h2, h3 {
    color: #b77aff;
    margin-bottom: 10px;
  }
  button {
    background: #4b0082;
    border: none;
    padding: 12px 20px;
    margin: 10px 5px 20px 0;
    border-radius: 8px;
    color: #ffd7ff;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 10px #7a0effcc;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #7a0eff;
  }
  #messages {
    background: #330044;
    padding: 15px;
    border-radius: 8px;
    height: 250px;
    overflow-y: auto;
    border: 1px solid #7a0eff;
    margin-bottom: 15px;
    font-size: 14px;
  }
  .message {
    margin-bottom: 8px;
  }
  .alert { color: #ff6a6a; font-weight: bold; }
  .success { color: #7aff7a; font-weight: bold; }
  .event { color: #ffa500; font-weight: bold; }
  #stats {
    margin-bottom: 20px;
  }
  #stats span {
    display: inline-block;
    margin-right: 15px;
    font-weight: bold;
  }
  #choices button {
    margin-right: 10px;
  }
  .hidden { display: none; }
  #universe-info {
    margin: 15px 0;
    padding: 12px;
    background: #440066;
    border-radius: 8px;
    box-shadow: inset 0 0 10px #a65aff;
  }
  #skill-tree {
    background: #2c0033;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  #skill-tree h3 {
    margin-top: 0;
  }
  .skill {
    cursor: pointer;
    margin: 5px 0;
    padding: 6px 10px;
    background: #551a8b;
    border-radius: 5px;
    box-shadow: 0 0 8px #a65affcc;
    transition: background 0.3s ease;
  }
  .skill.unlocked {
    background: #a65aff;
    box-shadow: 0 0 15px #ffaeff;
  }
  .skill:hover {
    background: #7a3aff;
  }
</style>
</head>
<body>
<div id="game-container">
  <h1>🩸 إمبراطورية المخدرات - النسخة المظلمة</h1>

  <div id="stats">
    <span>💰 المال: <span id="money">10000</span>$</span>
    <span>💊 المخدرات: <span id="drugs">200</span> جم</span>
    <span>🔫 الأسلحة: <span id="weapons">10</span></span>
    <span>🕵️‍♂️ شكوك الشرطة: <span id="police">0</span></span>
    <span>🧠 سمعة: <span id="reputation">50</span>%</span>
    <span>📅 اليوم: <span id="day">1</span></span>
  </div>

  <div id="universe-info" class="hidden"></div>

  <div id="messages"></div>

  <div id="choices"></div>

  <div id="skill-tree" class="hidden">
    <h3>⚡ شجرة المهارات</h3>
    <div id="skills-list"></div>
  </div>

  <button id="next-day-btn">▶️ اليوم التالي</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
<script>
  // ======== الحالة الأولية ========
  const state = {
    money: 10000,
    drugs: 200,
    weapons: 10,
    police: 0,
    reputation: 50,
    day: 1,
    universe: 'الواقع الأساسي',
    skills: {
      stealth: { name: "التسلل", unlocked: false, desc: "تقليل شكوك الشرطة بنسبة 20%" },
      negotiation: { name: "التفاوض", unlocked: false, desc: "زيادة المال من الصفقات 15%" },
      intimidation: { name: "الترهيب", unlocked: false, desc: "زيادة سمعة العصابة 10%" }
    },
    nemesisAI: null,
    playerActions: [],
  };

  // ======== واجهة المستخدم ========
  const messagesEl = document.getElementById('messages');
  const choicesEl = document.getElementById('choices');
  const moneyEl = document.getElementById('money');
  const drugsEl = document.getElementById('drugs');
  const weaponsEl = document.getElementById('weapons');
  const policeEl = document.getElementById('police');
  const reputationEl = document.getElementById('reputation');
  const dayEl = document.getElementById('day');
  const universeInfoEl = document.getElementById('universe-info');
  const skillTreeEl = document.getElementById('skill-tree');
  const skillsListEl = document.getElementById('skills-list');

  // ======== وظائف تحديث الواجهة ========
  function updateStats() {
    moneyEl.textContent = state.money.toLocaleString();
    drugsEl.textContent = state.drugs.toLocaleString();
    weaponsEl.textContent = state.weapons;
    policeEl.textContent = state.police;
    reputationEl.textContent = state.reputation;
    dayEl.textContent = state.day;
  }

  function addMessage(text, type='') {
    const div = document.createElement('div');
    div.className = 'message ' + type;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function clearChoices() {
    choicesEl.innerHTML = '';
  }

  // ======== نظام الذكاء الاصطناعي NemesisAI ========
  class NemesisAI {
    constructor() {
      this.model = null;
      this.playerHistory = [];
      this.initModel();
    }
    async initModel() {
      this.model = tf.sequential();
      this.model.add(tf.layers.dense({units: 16, activation: 'relu', inputShape: [5]}));
      this.model.add(tf.layers.dense({units: 8, activation: 'relu'}));
      this.model.add(tf.layers.dense({units: 3, activation: 'softmax'}));
      this.model.compile({optimizer: 'adam', loss: 'categoricalCrossentropy'});
    }
    logAction(actionVector) {
      this.playerHistory.push(actionVector);
      if (this.playerHistory.length > 20) {
        this.trainModel();
      }
    }
    async trainModel() {
      const xs = tf.tensor2d(this.playerHistory);
      const ys = tf.oneHot(tf.tensor1d(this.playerHistory.map((_, i) => i % 3), 'int32'), 3);
      await this.model.fit(xs, ys, {epochs: 5});
    }
    predictNextMove(stateVector) {
      if (!this.model) return null;
      const input = tf.tensor2d([stateVector]);
      const prediction = this.model.predict(input);
      return prediction.argMax(1).dataSync()[0];
    }
  }

  // ======== الأكوان المتوازية ========
  const universes = [
    {
      name: 'الواقع الأساسي',
      drugModifier: 1,
      policeModifier: 1,
      description: 'العالم الذي تعرفه، حيث تبدأ الرحلة.'
    },
    {
      name: 'عالم الظل',
      drugModifier: 1.5,
      policeModifier: 1.8,
      description: 'عالم مظلم حيث الشرطة أشد شراسة.'
    },
    {
      name: 'العالم السيبراني',
      drugModifier: 2.5,
      policeModifier: 0.7,
      description: 'عالم متطور تقنيًا، الأسعار مرتفعة والشرطة أقل قسوة.'
    }
  ];

  function showUniverseInfo() {
    universeInfoEl.classList.remove('hidden');
    universeInfoEl.innerHTML = `<h3>🌌 الكون الحالي: ${state.universe}</h3><p>${universes.find(u=>u.name===state.universe).description}</p>`;
  }

  // ======== شجرة المهارات ========
  function renderSkills() {
    skillsListEl.innerHTML = '';
    Object.entries(state.skills).forEach(([key, skill]) => {
      const skillEl = document.createElement('div');
      skillEl.className = 'skill' + (skill.unlocked ? ' unlocked' : '');
      skillEl.textContent = skill.name + (skill.unlocked ? ' ✅' : '');
      skillEl.title = skill.desc;
      skillEl.onclick = () => {
        if (!skill.unlocked && state.money >= 5000) {
          skill.unlocked = true;
          state.money -= 5000;
          addMessage(`⚡ تم فتح المهارة: ${skill.name}`, 'success');
          updateStats();
          renderSkills();
        }
      };
      skillsListEl.appendChild(skillEl);
    });
    skillTreeEl.classList.remove('hidden');
  }

  // ======== مهام اللعبة ========
  function presentChoices(choices) {
    clearChoices();
    choices.forEach(choice => {
      const btn = document.createElement('button');
      btn.textContent = choice.text;
      btn.onclick = () => {
        choice.action();
      };
      choicesEl.appendChild(btn);
    });
  }

  // ======== السيناريوهات ========
  function startDay() {
    addMessage(`📅 اليوم ${state.day} يبدأ...`, 'event');

    // زيادة الشكوك يوميًا بنسبة عشوائية
    state.police += Math.floor(Math.random() * 3);
    if (state.police > 100) state.police = 100;

    // احتمال حدوث حدث عشوائي سلبي أو إيجابي
    const eventChance = Math.random();
    if (eventChance < 0.2) {
      addMessage('💣 حدث غير متوقع: الشرطة تقوم بمداهمة!', 'alert');
      state.drugs = Math.max(0, state.drugs - Math.floor(Math.random() * 50));
      state.money = Math.max(0, state.money - Math.floor(Math.random() * 2000));
      state.reputation = Math.max(0, state.reputation - 5);
    } else if (eventChance < 0.3) {
      addMessage('🎉 حدث سعيد: صفقة مربحة ناجحة!', 'success');
      state.money += Math.floor(Math.random() * 5000) + 1000;
      state.drugs = Math.max(0, state.drugs - Math.floor(Math.random() * 30));
      state.reputation += 3;
    }

    updateStats();
    showUniverseInfo();

    presentChoices([
      { text: 'بيع المخدرات', action: sellDrugs },
      { text: 'شراء الأسلحة', action: buyWeapons },
      { text: 'التهرب من الشرطة', action: evadePolice },
      { text: 'استكشاف كون جديد', action: jumpUniverse },
      { text: 'فتح شجرة المهارات', action: renderSkills }
    ]);
  }

  // ======== إجراءات المهام ========
  function sellDrugs() {
    if (state.drugs < 10) {
      addMessage('⚠️ لا تملك مخدرات كافية للبيع.', 'alert');
      return startDay();
    }
    const basePrice = 100;
    let price = basePrice * universes.find(u => u.name === state.universe).drugModifier;
    if (state.skills.negotiation.unlocked) price *= 1.15;
    const amount = Math.min(state.drugs, Math.floor(Math.random() * 50) + 10);
    const gain = Math.floor(amount * price);

    state.drugs -= amount;
    state.money += gain;
    addMessage(`💰 بعت ${amount} جم مخدرات مقابل $${gain}.`, 'success');

    // تقليل الشكوك قليلاً بسبب البيع الناجح
    state.police = Math.max(0, state.police - 2);
    if (state.skills.stealth.unlocked) state.police = Math.max(0, state.police - 3);

    state.reputation += 1;
    updateStats();
    startDay();
  }

  function buyWeapons() {
    const weaponPrice = 500;
    if (state.money < weaponPrice) {
      addMessage('⚠️ لا تملك مالاً كافياً لشراء الأسلحة.', 'alert');
      return startDay();
    }
    state.money -= weaponPrice;
    state.weapons += 1;
    addMessage('🔫 اشتريت سلاحاً جديداً.', 'success');

    // شراء الأسلحة يزيد من الشكوك قليلاً
    state.police += 2;
    updateStats();
    startDay();
  }

  function evadePolice() {
    if (state.police < 10) {
      addMessage('🛡️ لا حاجة للتهرب، الشرطة غير مشتبه بك بشدة.', 'event');
      return startDay();
    }
    const evadeChance = 0.5 + (state.weapons * 0.02);
    if (Math.random() < evadeChance) {
      addMessage('🚔 نجحت في التهرب من الشرطة!', 'success');
      state.police = Math.max(0, state.police - 15);
      state.reputation += 2;
    } else {
      addMessage('❌ فشلت في التهرب! الشرطة تضغط عليك.', 'alert');
      state.police += 10;
      state.money = Math.max(0, state.money - 3000);
      state.drugs = Math.max(0, state.drugs - 50);
      state.reputation = Math.max(0, state.reputation - 10);
    }
    updateStats();
    startDay();
  }

  function jumpUniverse() {
    const currentIndex = universes.findIndex(u => u.name === state.universe);
    const nextIndex = (currentIndex + 1) % universes.length;
    state.universe = universes[nextIndex].name;
    addMessage(`🌌 انتقلت إلى الكون: ${state.universe}`, 'event');
    updateStats();
    startDay();
  }

  // ======== بدء اللعبة ========
  async function initGame() {
    state.nemesisAI = new NemesisAI();
    updateStats();
    addMessage('🔥 مرحبًا بك في عالم إمبراطورية المخدرات المظلم!', 'event');
    showUniverseInfo();
    startDay();
  }

  // ======== زر اليوم التالي ========
  document.getElementById('next-day-btn').addEventListener('click', () => {
    state.day++;
    startDay();
  });

  initGame();
</script>
</body>
</html>
