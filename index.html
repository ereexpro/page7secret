<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>💰 إمبراطورية اللوجستيك - لعبة العصابات والتهريب</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
  }
  nav {
    background: #1f1f1f;
    padding: 10px;
    display: flex;
    gap: 8px;
    justify-content: center;
    border-bottom: 2px solid #b31217;
  }
  nav button {
    background: #b31217;
    border: none;
    padding: 10px 16px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.3s ease;
  }
  nav button:hover, nav button.active {
    background: #ee2f35;
  }
  .screen {
    display: none;
    padding: 15px 25px;
  }
  .screen.active {
    display: block;
  }
  h2, h3, h4 {
    margin-top: 0;
  }
  .card {
    background: #1e1e1e;
    margin: 10px 0;
    padding: 12px 15px;
    border-radius: 6px;
    box-shadow: 0 0 8px #b31217cc;
  }
  .action-btn {
    background: #b31217;
    color: white;
    border: none;
    padding: 6px 12px;
    margin-top: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
  }
  .action-btn:hover:enabled {
    background: #ee2f35;
  }
  .action-btn:disabled {
    background: #770a0c;
    cursor: not-allowed;
  }
  #events-log {
    height: 150px;
    overflow-y: auto;
    background: #222;
    padding: 10px;
    font-family: monospace;
    font-size: 0.9em;
    border-radius: 4px;
    white-space: pre-wrap;
  }
  label {
    display: inline-block;
    margin: 5px 0 3px 0;
  }
  select, input[type=number] {
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: none;
    margin-bottom: 8px;
    background: #333;
    color: white;
  }
  #risk-display {
    font-weight: bold;
    margin: 10px 0;
    font-size: 1.2em;
    color: #ff4444;
  }
  hr {
    border: 1px solid #b31217;
    margin: 20px 0;
  }
</style>
</head>
<body>

<nav>
  <button onclick="switchScreen('gang')" class="active">🕶️ عصابتك</button>
  <button onclick="switchScreen('market')">🏪 السوق</button>
  <button onclick="switchScreen('loans')">💸 القروض</button>
  <button onclick="switchScreen('shipments')">🚚 الشحنات</button>
  <button onclick="switchScreen('events')">📜 الأحداث</button>
</nav>

<!-- شاشة عصابتك -->
<div id="gang" class="screen active">
  <h2>عصابتك</h2>
  <div class="card">
    <p>💰 المال: <span id="gang-money"></span> درهم</p>
    <p>👥 عدد العاملين: <span id="gang-workers"></span></p>
    <p>🚛 عدد الشاحنات: <span id="gang-trucks"></span></p>
    <p>📦 عدد السلع في المخزون: <span id="gang-inventory"></span></p>
  </div>
</div>

<!-- شاشة السوق -->
<div id="market" class="screen">
  <h2>الموردون في السوق السوداء</h2>
  <div id="supplier-list"></div>

  <hr />

  <h3>شراء العمال</h3>
  <div id="worker-suppliers"></div>

  <hr />

  <h3>شراء الشاحنات</h3>
  <div id="truck-suppliers"></div>
</div>

<!-- شاشة القروض -->
<div id="loans" class="screen">
  <h2>القروض والتمويل</h2>
  <div id="loan-info" class="card"></div>

  <h3>أخذ قرض جديد</h3>
  <label for="loan-amount">المبلغ (درهم):</label>
  <input id="loan-amount" type="number" min="1000" disabled />
  <label for="loan-interest">نسبة الفائدة %:</label>
  <input id="loan-interest" type="number" min="5" disabled />
  <button id="take-loan-btn" class="action-btn" disabled onclick="takeLoan()">أخذ قرض</button>

  <hr />

  <h3>إعطاء قرض (مقفل)</h3>
  <label for="give-loan-amount">المبلغ (درهم):</label>
  <input id="give-loan-amount" type="number" min="1000" disabled />
  <label for="give-loan-interest">نسبة الفائدة %:</label>
  <input id="give-loan-interest" type="number" min="5" disabled />
  <button id="give-loan-btn" class="action-btn disabled" disabled onclick="giveLoan()">إعطاء قرض</button>
</div>

<!-- شاشة الشحنات -->
<div id="shipments" class="screen">
  <h2>الشحنات</h2>
  
  <label for="select-route">اختر المسار:</label>
  <select id="select-route" onchange="onSelectionChange()"></select>

  <label for="select-truck">اختر الشاحنة:</label>
  <select id="select-truck" onchange="onSelectionChange()"></select>

  <label for="select-worker">اختر السائق:</label>
  <select id="select-worker" onchange="onSelectionChange()"></select>

  <label for="shipment-qty">كمية البضاعة للإرسال:</label>
  <input id="shipment-qty" type="number" min="1" value="1" onchange="validateShipmentQty()" />

  <div id="risk-display">نسبة الخطر: 0%</div>

  <button class="action-btn" onclick="sendShipment()">إرسال الشحنة</button>

  <div id="shipping-status" style="margin-top: 10px;"></div>
</div>

<!-- شاشة الأحداث -->
<div id="events" class="screen">
  <h2>سجل الأحداث</h2>
  <div id="events-log"></div>
</div>

<script>
  // البيانات الأساسية واللاعب
  let money = 10000;
  let gangWorkers = 5;
  let gangTrucks = 2;
  let inventory = 0;

  let loanAmount = 0;
  let loanInterest = 10; // نسبة الفائدة %
  let loanDueTurns = 5; // دورات للسداد قبل زيادة الفائدة
  let debtUnpaidTurns = 0;

  let currentTurn = 1;
  let shippingInProgress = false;
  let shippingTimer = 0;
  let shippingDetails = null;
  let stage = 1; // مستوى صعوبة متغير

  let eventsLog = [];

  // بيانات الموردين (عمال وشاحنات)
  const workerSuppliers = [
    { id: 'jack', name: 'Jack the Hustler', temperament: 'greedy', basePrice: 2200 },
    { id: 'lisa', name: 'Lisa the Loyal', temperament: 'friendly', basePrice: 1800 }
  ];
  const truckSuppliers = [
    { id: 'speedy', name: 'Speedy Truck Co.', temperament: 'aggressive', basePrice: 16000,
      features: { speed: 8, capacity: 100, security: 3 } },
    { id: 'tank', name: 'Tank Haulers', temperament: 'defensive', basePrice: 20000,
      features: { speed: 5, capacity: 150, security: 8 } }
  ];

  // بيانات العمال المتوفرين (للسيارات)
  let workers = [
    { id: 'w1', name: 'علي', skill: 'مبتدئ', skillValue: 1, price: 1500 },
    { id: 'w2', name: 'سارة', skill: 'متوسط', skillValue: 2, price: 3000 },
    { id: 'w3', name: 'عمر', skill: 'رائع', skillValue: 3, price: 6000 },
    { id: 'w4', name: 'نورا', skill: 'أسطوري', skillValue: 5, price: 12000 }
  ];

  // الشاحنات المتوفرة فعلياً
  let trucks = [
    { id: 't1', name: 'Speedy', security: 3, capacity: 100, speed: 8 },
    { id: 't2', name: 'Tank', security: 8, capacity: 150, speed: 5 }
  ];

  // المسارات المتاحة
  let routes = [
    { id: 'safe', name: 'مسار آمن', baseRisk: 10 },
    { id: 'risky', name: 'مسار محفوف بالمخاطر', baseRisk: 40 },
    { id: 'darkweb', name: 'مسار دارك ويب', baseRisk: 60 }
  ];

  // سحب البيانات من القوائم
  function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    event.target?.classList.add('active');
  }

  // تحديث بيانات عصابتك
  function renderGangInfo() {
    document.getElementById('gang-money').textContent = money;
    document.getElementById('gang-workers').textContent = gangWorkers;
    document.getElementById('gang-trucks').textContent = gangTrucks;
    document.getElementById('gang-inventory').textContent = inventory;
  }

  // عرض الموردين للعمال
  function renderWorkerSuppliers() {
    const container = document.getElementById('worker-suppliers');
    container.innerHTML = '';
    workerSuppliers.forEach(s => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h4>${s.name}</h4>
        <p>السعر المبدئي: ${s.basePrice} درهم</p>
        <button class="action-btn" onclick="negotiateWithSupplier('worker', '${s.id}')">تفاوض وشراء</button>
      `;
      container.appendChild(card);
    });
  }
  // عرض الموردين للشاحنات
  function renderTruckSuppliers() {
    const container = document.getElementById('truck-suppliers');
    container.innerHTML = '';
    truckSuppliers.forEach(s => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h4>${s.name}</h4>
        <p>السعر المبدئي: ${s.basePrice} درهم</p>
        <p>السرعة: ${s.features.speed} | السعة: ${s.features.capacity} | الأمان: ${s.features.security}</p>
        <button class="action-btn" onclick="negotiateWithSupplier('truck', '${s.id}')">تفاوض وشراء</button>
      `;
      container.appendChild(card);
    });
  }

  // تحديث عرض المال في عنوان التبويب
  function updateMoneyDisplay() {
    document.title = `💰 ${money} درهم - إمبراطورية اللوجستيك`;
    renderGangInfo();
  }

  // دالة التفاوض وشراء
  function negotiateWithSupplier(type, id) {
    let supplier;
    if (type === 'worker') {
      supplier = workerSuppliers.find(s => s.id === id);
    } else if (type === 'truck') {
      supplier = truckSuppliers.find(s => s.id === id);
    }
    if (!supplier) return alert('المورد غير موجود');

    let price = supplier.basePrice;
    switch (supplier.temperament) {
      case 'greedy': price = Math.floor(price * 1.2); break;
      case 'friendly': price = Math.floor(price * 0.85); break;
      case 'aggressive': price = Math.floor(price * 1.3); break;
      case 'defensive': price = Math.floor(price * 1.1); break;
    }

    if (!confirm(`${supplier.name} يعرض ${price} درهم. هل تقبل الشراء؟`)) return;

    if (money < price) {
      alert('ليس لديك مال كافي للشراء.');
      return;
    }
    money -= price;
    if (type === 'worker') {
      gangWorkers++;
      addEventLog(`👥 اشتريت عامل جديد من ${supplier.name} مقابل ${price} درهم.`);
    } else if (type === 'truck') {
      gangTrucks++;
      // إضافة الشاحنة الجديدة مع خصائصها
      trucks.push({
        id: supplier.id + '_' + Date.now(),
        name: supplier.name,
        security: supplier.features.security,
        capacity: supplier.features.capacity,
        speed: supplier.features.speed
      });
      addEventLog(`🚛 اشتريت شاحنة جديدة من ${supplier.name} مقابل ${price} درهم.`);
    }
    updateMoneyDisplay();
  }

  // حساب نسبة الخطر قبل الإرسال
  function calculateRisk(routeId, truckId, workerId, stage) {
    let route = routes.find(r => r.id === routeId);
    let truck = trucks.find(t => t.id === truckId);
    let worker = workers.find(w => w.id === workerId);

    if (!route || !truck || !worker) return 0;

    let risk = route.baseRisk;
    risk -= truck.security * 2;
    risk -= worker.skillValue * 3;
    risk += stage * 5;
    risk = Math.min(Math.max(risk, 5), 95);

    return risk;
  }

  // تحديث عرض نسبة الخطر
  function updateRiskDisplay() {
    const routeId = document.getElementById('select-route').value;
    const truckId = document.getElementById('select-truck').value;
    const workerId = document.getElementById('select-worker').value;
    const risk = calculateRisk(routeId, truckId, workerId, stage);
    document.getElementById('risk-display').textContent = `نسبة الخطر: ${risk}% ⚠️`;
  }

  // التحقق من كمية الشحنة متاحة في المخزون
  function validateShipmentQty() {
    const qtyInput = document.getElementById('shipment-qty');
    let val = parseInt(qtyInput.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > inventory) {
      alert("لا يوجد كمية كافية في المخزون.");
      val = inventory;
    }
    qtyInput.value = val;
  }

  // إرسال الشحنة
  let shippingTimer = 0;
  let shippingInProgress = false;
  let shippingDetails = null;

  function sendShipment() {
    if (shippingInProgress) {
      alert("هناك شحنة جارية بالفعل!");
      return;
    }
    const routeId = document.getElementById('select-route').value;
    const truckId = document.getElementById('select-truck').value;
    const workerId = document.getElementById('select-worker').value;
    let qty = parseInt(document.getElementById('shipment-qty').value);

    if (!routeId || !truckId || !workerId) {
      alert("اختر المسار، الشاحنة، والسائق.");
      return;
    }
    if (qty < 1 || qty > inventory) {
      alert("كمية غير صالحة للإرسال.");
      return;
    }
    shippingInProgress = true;
    shippingTimer = 5; // مثلا 5 دورات (تعديل حسب السرعة لاحقا)
    shippingDetails = { route: routeId, qty, truckId, workerId };

    inventory -= qty;
    updateMoneyDisplay();
    addEventLog(`🚚 تم إرسال شحنة ${qty} وحدة عبر ${routes.find(r=>r.id===routeId).name}.`);

    document.getElementById('shipping-status').textContent = `الشحن جارٍ... تبقى ${shippingTimer} دورات.`;
  }

  // سجل الأحداث
  function addEventLog(text) {
    eventsLog.unshift(`[الدور ${currentTurn}] ${text}`);
    if (eventsLog.length > 50) eventsLog.pop();
    document.getElementById('events-log').textContent = eventsLog.join('\n');
  }

  // تحديث كل دورة (turn)
  function runTurn() {
    if (shippingInProgress) {
      shippingTimer--;
      if (shippingTimer <= 0) {
        shippingInProgress = false;
        // احتمال اعتراض الشرطة بناء على الخطر
        const risk = calculateRisk(shippingDetails.route, shippingDetails.truckId, shippingDetails.workerId, stage);
        if (Math.random() < risk / 100) {
          addEventLog("🚨 تم اعتراض الشحنة من قبل الشرطة! خسرت البضاعة ودُفعت غرامة.");
          money -= 2000;
          if (money < 0) money = 0;
        } else {
          const pricePerUnit = 700 + stage * 100;
          const gain = shippingDetails.qty * pricePerUnit;
          money += gain;
          addEventLog(`✅ وصلت الشحنة من ${shippingDetails.qty} وحدة بأمان. ربح: ${gain} درهم.`);
        }
        updateMoneyDisplay();
        document.getElementById('shipping-status').textContent = "لا توجد شحنات نشطة.";
        shippingDetails = null;
      } else {
        document.getElementById('shipping-status').textContent = `الشحن جارٍ... تبقى ${shippingTimer} دورات.`;
      }
    }

    // قرض - حساب الفائدة ومدة السداد
    if (loanAmount > 0) {
      loanDueTurns--;
      if (loanDueTurns <= 0) {
        debtUnpaidTurns++;
        loanInterest += 5;
        addEventLog(`⚠️ لم تسدد القرض في الوقت المحدد. الفائدة زادت إلى ${loanInterest}%.`);
        loanDueTurns = 5;
      }
    }

    currentTurn++;
  }

  // عرض القرض
  function renderLoanInfo() {
    const loanInfo = document.getElementById('loan-info');
    if (loanAmount > 0) {
      loanInfo.innerHTML = `
        لديك قرض بمبلغ ${loanAmount} درهم.
        نسبة الفائدة الحالية: ${loanInterest}%
        يجب السداد خلال ${loanDueTurns} دورات.
      `;
      document.getElementById('loan-amount').disabled = true;
      document.getElementById('loan-interest').disabled = true;
      document.getElementById('take-loan-btn').disabled = true;
    } else {
      loanInfo.textContent = "ليس لديك أي قرض حالياً.";
      document.getElementById('loan-amount').disabled = false;
      document.getElementById('loan-interest').disabled = false;
      document.getElementById('take-loan-btn').disabled = false;
    }
  }

  function takeLoan() {
    const amountInput = document.getElementById('loan-amount');
    const interestInput = document.getElementById('loan-interest');
    let amt = parseInt(amountInput.value);
    let intr = parseInt(interestInput.value);

    if (isNaN(amt) || amt < 1000) {
      alert("أدخل مبلغ قرض صالح (1000 درهم أو أكثر).");
      return;
    }
    if (isNaN(intr) || intr < 5) {
      alert("أدخل نسبة فائدة صحيحة (5% أو أكثر).");
      return;
    }
    loanAmount = amt;
    loanInterest = intr;
    loanDueTurns = 5;
    debtUnpaidTurns = 0;
    money += amt;
    addEventLog(`💰 أخذت قرضًا بمبلغ ${amt} درهم بفائدة ${intr}%.`);
    updateMoneyDisplay();
    renderLoanInfo();
  }

  // توسيع وتعديل دالة init
  function init() {
    renderGangInfo();
    renderWorkerSuppliers();
    renderTruckSuppliers();
    renderLoanInfo();
    populateShipmentsSelectors();
    updateRiskDisplay();
    addEventLog("🔥 تم بدء اللعبة. حظًا موفقًا!");
  }

  // تعبئة قوائم اختيار الشحنات
  function populateShipmentsSelectors() {
    const routeSel = document.getElementById('select-route');
    const truckSel = document.getElementById('select-truck');
    const workerSel = document.getElementById('select-worker');

    routeSel.innerHTML = '';
    routes.forEach(r => {
      let opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.name;
      routeSel.appendChild(opt);
    });

    truckSel.innerHTML = '';
    trucks.forEach(t => {
      let opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} (سعة: ${t.capacity}, أمان: ${t.security})`;
      truckSel.appendChild(opt);
    });

    workerSel.innerHTML = '';
    workers.forEach(w => {
      let opt = document.createElement('option');
      opt.value = w.id;
      opt.textContent = `${w.name} - ${w.skill} (سعر: ${w.price} درهم)`;
      workerSel.appendChild(opt);
    });
  }

  // عند تغيير الاختيارات
  function onSelectionChange() {
    updateRiskDisplay();
  }

  // تنفيذ دور (turn)
  function nextTurn() {
    runTurn();
    renderLoanInfo();
    updateMoneyDisplay();
  }

  // دالة مساعدة لإضافة الأحداث للسجل
  function addEventLog(text) {
    eventsLog.unshift(`[الدور ${currentTurn}] ${text}`);
    if (eventsLog.length > 50) eventsLog.pop();
    document.getElementById('events-log').textContent = eventsLog.join('\n');
  }

  // بدء اللعبة
  window.onload = () => {
    init();

    // زيادة الدور تلقائيا كل 10 ثواني (مثال)
    setInterval(() => {
      nextTurn();
    }, 10000);
  }
</script>

</body>
</html>
